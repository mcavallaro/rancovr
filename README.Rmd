---
title: "rancovr. Cluster detection with Random Neighbourhood Covering"
author: Massimo Cavallaro
output:
  md_document:
    variant: markdown_github
---

```{r eval=TRUE, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Documents/rancovr")
devtools::load_all(".")
```

# Rancovr: Cluster detection in R with Random Neighbourhood Covering

`rancovr` is a statistical software package written in R for the detection of disease clusters
based on the  Random Neighbourhood Covering (RaNCover) of reference [1].
`rancovr` assess whether a single recorded infection is part of a disease cluster (such that caused by a local outbreak)
or is consistent with a baseline of sporadic cases.


```{r eval=FALSE, include=TRUE}
install.packages("devtools")
devtools::install_github("mcavallaro/rancovr")
```


As a demonstration, we consider the spatio-temporal coordinates stored in `Data/synthetic_dataset.csv`,
which represent records of infection cases and is obtained aggregating data simulated from an endemic component (`end.`) and
from an outbreak (`epi.`) in the UK. See reference [1] for the simulation details.


```{r eval=FALSE, include=TRUE}
case.df = read.csv(file=system.file('extdata', 'synthetic_dataset.csv' , package='rancovr'), sep = ',', stringsAsFactors = F)
```

```{r eval=TRUE, include=FALSE}
case.df = read.csv(file='inst/extdata/synthetic_dataset.csv', sep = ',', stringsAsFactors = F)
```

```{r}
head(case.df)
```

```{r}
CreateObservationMatrices(case.df)
```

```{r}
time.factor = TimeFactor(case.df, n.iterations=5)
baseline.matrix = CreateBaselineMatrix(case.df , save.on.dir = T)
```

```{r}
load(file.path(getwd(), "observation_matrix_tmp.Rdata"), verbose=1)
plot(time.factor, xlab = 'Week', ylab='Number of cases', xaxt='n')
lines(colSums(baseline.matrix))
lines(colSums(observation.matrix))
axis(side=1, at=1:length(time.factor), labels = names(time.factor))
legend('bottomright',legend=c('Baseline', 'Observations'), pch=c(1, NA), lty=c(1,1))
```


Create  100,000 cyclinders to cover the detected cases:

```{r}
cylinders = CreateCylinders(observation.matrix = observation.matrix,
                            baseline.matrix = baseline.matrix,
                            week.range = c(0,99), n.cylinders = 1000)
head(cylinders)
```


Compute the warning score for each case:
```{r}
case.df[,'warning.score'] = apply(case.df, 1, FUN=warning.score, cylinders)
head(case.df)
```

Assess concordance with ROC-ACU
```{r}
library(pROC)
ROC = roc(ifelse(case.df$sim == 'end.', FALSE, TRUE), case.df$warning.score)
plot(ROC)
```

[1] M. Cavallaro, J. Coelho, D. Ready, V. Decraene, T. Lamagni, N. D. McCarthy, D. Todkill, M. J. Keeling,
Cluster detection with random neighbourhood covering: application to invasive Group A Streptococcal disease, 2021
medRxiv 2021.10.20.21264984; doi: https://doi.org/10.1101/2021.10.20.21264984

