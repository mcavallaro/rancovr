---
title: "rancovr. Cluster detection with Random Neighbourhood Covering"
author: Massimo Cavallaro
output:
  md_document:
    variant: markdown_github
---

```{r eval=TRUE, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Documents/rancovr")
devtools::load_all(".")
```

# Rancovr: Cluster detection in R with Random Neighbourhood Covering

`rancovr` is a statistical software package written in R for the detection of disease clusters.
It implements the Random Neighbourhood Covering (RaNCover) approach of reference [1].
RaNCover assigns a score $w \in [0,1]$ to each records.
A high score suggests that the record is likely to be part of a cluster (e.g., and infection case caused by a local outbreak).


```{r eval=FALSE, include=TRUE}
install.packages("devtools")
devtools::install_github("mcavallaro/rancovr")
```


As a demonstration, we consider the spatio-temporal coordinates stored in `Data/synthetic_dataset.csv`,
which represent records of infection cases and is obtained aggregating data simulated from an endemic component (`end.`) and
from an outbreak (`epi.`) in the UK. See reference [1] for the simulation details.


```{r eval=FALSE, include=TRUE}
case.df = read.csv(file=system.file('extdata', 'synthetic_dataset.csv' , package='rancovr'), sep = ',', stringsAsFactors = F)
```

```{r eval=TRUE, include=FALSE}
case.df = read.csv(file='inst/extdata/synthetic_dataset.csv', sep = ',', stringsAsFactors = F)
```

```{r}
head(case.df)
```

```{r}
plotBaseMap(add=F, xlim=range(case.df$longitude), ylim=range(case.df$latitude))
points(case.df$longitude, case.df$latitude,
       col=ifelse(case.df$sim=='epi.', tab.red, tab.blue),
       pch=ifelse(case.df$sim=='epi.', 1, 20),
       cex=ifelse(case.df$sim=='epi.', 0.6, 0.2))
legend('topright',c('end.','epi.'), pch=c(20,1), col=c(tab.blue, tab.red))
```

```{r}
CreateObservationMatrices(case.df)
```

```{r}
time.factor = TimeFactor(case.df, n.iterations=5)
#baseline.matrix = CreateBaselineMatrix(case.df , save.on.dir = T)
```

```{r}
baseline.tab = tabulated.baseline(case.df)
```

```{r}
library(Matrix)
load(file.path(getwd(), "observation_matrix_tmp.Rdata"), verbose=1)
plot(time.factor, xlab = 'Week', ylab='Number of cases', xaxt='n')
# lines(colSums(baseline.matrix))
points(colSums(observation.matrix), pch='+')
axis(side=1, at=1:length(time.factor), labels = names(time.factor))
legend('bottomright',legend=c('Baseline', 'Observations'), pch=c('o', '+'), lty=c(1, NA))
```


Create  10,000 cylinders to cover the detected cases:

```{r eval=FALSE, include=TRUE}
cylinders = CreateCylinders(observation.matrix, baseline.tab, week.range = c(0,99), n.cylinders = 10000)
head(cylinders)
```


```{r eval=TRUE, include=FALSE}
load("cylinders.rdata")
head(cylinders)
```

Some cylinders contain much more cases than the baseline expectation:
```{r}
plotCylindersCI(cylinders, confidence.level = 0.95)
```



Compute the warning score for each case:
```{r}
case.df[,'warning.score'] = apply(case.df, 1, FUN=warning.score, cylinders)
head(case.df)
```

Assess concordance with ROC-ACU:
```{r}
library(pROC)
ROC = roc(ifelse(case.df$sim == 'end.', FALSE, TRUE), case.df$warning.score)
plot(ROC)
```

With mean squared error:
```{r}
case.df$y = ifelse(case.df$sim == 'epi.',1,0)
case.df$sqerr = (case.df$y - case.df$warning.score)^2
print(mean(case.df$sqerr))
```


And with a map:
```{r}
plotBaseMap(add=F, xlim=c(-0.6,0.6), ylim=c(51.648,51.65))
#plotBaseMap(add=F, xlim=c(-1,1), ylim=c(50.648,52.65))
points(case.df$longitude, case.df$latitude,
       col=ifelse(case.df$sim=='epi.', tab.red, tab.blue),
       pch=ifelse(case.df$sim=='epi.', 4, 20),
       cex=ifelse(case.df$sim=='epi.', 1, 0.5))
points(case.df[case.df$warning.score>0.95,]$longitude, case.df[case.df$warning.score>0.95,]$latitude,
       col=tab.orange,
       pch=1,
       cex=1)
# case.df$color = rgb(colorRamp(c("blue", "red"))(case.df$warning.score) / 255)
# plot(case.df$longitude, case.df$latitude, col=case.df$color)

legend('topright',c('end.','true epi.', 'w>0.95'), pch=c(20,4,1), col=c(tab.blue, tab.red, tab.orange))
```

[1] M. Cavallaro, J. Coelho, D. Ready, V. Decraene, T. Lamagni, N. D. McCarthy, D. Todkill, M. J. Keeling,
Cluster detection with random neighbourhood covering: application to invasive Group A Streptococcal disease, 2021
medRxiv 2021.10.20.21264984; doi: https://doi.org/10.1101/2021.10.20.21264984

